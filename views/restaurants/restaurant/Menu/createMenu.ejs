<!DOCTYPE html>
<html>
  <head>
    <!-- Logotipo-->
    <link
      rel="icon"
      type="image/png"
      href="/images/Plataform/LogoSite/logo.png"
    />
    <!-- Link da fonte -->

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- CSS-->
    <link
      rel="stylesheet"
      href="/stylesheets/Restaurants/Restaurant/Pratos/portion.css"
    />
  </head>
  <body>
    <%- include('../navBarRest') %> <%- include('../../../hero', { content:
    restaurant.name, title: "Criar Menu" }) %>

    <div>
      <div class="container my-3" style="border-radius: 100">
        <a href="/restaurants/<%= restaurant.name %>" class="btn btn-primary"
          >&lt;</a
        >
      </div>
    </div>

    <% if (error && error.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <strong>Erro!</strong> <%= error %>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    <% } %>

    <!-- Formulário do Menu -->
    <div class="container my-5">
      <form
        action="/restaurants/<%= restaurant.name %>/confirmNutrition"
        method="post"
        enctype="multipart/form-data"
      >
      <!-- estava na linha a cima (57)-->
        <!-- Dados do Menu -->
        <div class="mb-3">
          <label for="menuName" class="form-label">Nome do Menu:</label>
          <input
            type="text"
            name="name"
            id="menuName"
            class="form-control"
            placeholder="Nome do Menu"
            required
            maxlength="50"
            pattern="^(?!.*[\\/]).+$"
            oninvalid="this.setCustomValidity('Introduza somente letras e espaços, máximo 50 caracteres.')"
          />
        </div>
        <div class="mb-3">
          <label for="menuPhoto" class="form-label">Foto do Menu:</label>
          <input
            type="file"
            accept="image/*"
            name="menuPhoto"
            id="menuPhoto"
            class="form-control"
            required
          />
        </div>
        <div class="mb-3">
          <label for="type" class="form-label">Tipo do Menu:</label>
          <% if (categories && categories.length > 0) { %>
          <select name="type" id="type" class="form-select" required>
            <% categories.forEach(function(cat) { %>
            <option value="<%= cat.category %>"><%= cat.category %></option>
            <% }); %>
          </select>
          <% } else { %>
          <!-- Caso não haja categorias, entrada de texto -->
          <input
            type="text"
            name="type"
            id="type"
            class="form-control"
            required
          />
          <% } %>
        </div>

        <!-- Área de cadastro dos pratos -->
        <h4>Pratos</h4>
        <div id="dishesContainer">
          <% if (error && error.length > 0) { %>
          <div class="alert alert-danger" role="alert"><%= error %></div>
          <% } %>

          <!-- Primeiro formulário de prato (index 0) -->
          <div class="dish-form border p-3 mb-3" data-index="0">
            <h5>Prato 1</h5>
            <div class="mb-3">
              <label for="dishName0" class="form-label">Nome:</label>
              <input
                type="text"
                name="dishes[0][name]"
                id="dishName0"
                class="form-control"
                placeholder="Nome do prato"
                required
                maxlength="50"
                pattern="^[A-Za-zÀ-ÿ\s]+$"
                oninvalid="this.setCustomValidity('Informe somente letras e espaços, máximo 50 caracteres.')"
              />
            </div>
            <div class="mb-3">
              <label for="dishDescription0" class="form-label"
                >Descrição:</label
              >
              <input
                type="text"
                name="dishes[0][description]"
                id="dishDescription0"
                class="form-control"
                placeholder="Descrição do prato"
                required
                maxlength="250"
                oninvalid="this.setCustomValidity('Descrição do prato, máximo 250 caracteres.')"
              />
            </div>
            <% if (categories && categories.length > 0) { %>
            <div class="mb-3">
              <label for="dishCategory0" class="form-label">Categoria:</label>
              <select
                name="dishes[0][category]"
                id="dishCategory0"
                class="form-select"
                required
              >
                <% categories.forEach(function(cat) { %>
                <option value="<%= cat.category %>"><%= cat.category %></option>
                <% }); %>
              </select>
            </div>
            <% } else { %>
            <div class="mb-3">
              <label for="dishCategory0" class="form-label">Categoria:</label>
              <input
                type="text"
                name="dishes[0][category]"
                id="dishCategory0"
                class="form-control"
                required
              />
            </div>
            <% } %>
            <div class="mb-3">
              <label for="dishPrice0" class="form-label">Preço:</label>
              <input
                type="number"
                name="dishes[0][price]"
                id="dishPrice0"
                class="form-control"
                placeholder="Preço do prato"
                required
                min="0"
                step="0.01"
                oninvalid="this.setCustomValidity('Informe um preço válido.')"
              />
            </div>

            <div class="mb-3">
              <label class="form-label">Ingredientes:</label>
              <div id="ingredientsContainer-0">
                <div class="ingredient-item mb-2">
                  <div class="input-group">
                    <select
                      class="form-select search-type"
                      style="max-width: 150px"
                    >
                      <option value="name">Por Nome</option>
                      <option value="barcode">Por Código</option>
                    </select>
                    <input
                      type="text"
                      name="dishes[0][ingredients][]"
                      class="form-control ingredient-input"
                      placeholder="Nome do ingrediente"
                    />
                    <button
                      type="button"
                      class="btn btn-outline-danger remove-ingredient"
                    >
                      ×
                    </button>
                  </div>
                </div>
              </div>
              <button
                type="button"
                class="btn btn-sm btn-secondary add-ingredient"
              >
                Adicionar Ingrediente
              </button>
              <small class="text-muted"
                >Apenas um ingrediente por caixa</small
              >
            </div>

            <div class="mb-3">
              <label class="form-label">Porções:</label>
              <div
                id="portionsContainer-0"
                class="portions-container mb-3"
                data-index="0"
              >
                <!-- Porções adicionadas aparecerão aqui -->
              </div>
              <div class="input-group">
                <select
                  id="portionSelect-0"
                  class="form-select portion-select"
                  data-index="0"
                  onchange="addPortion(this)"
                >
                  <option value="">Selecione uma porção...</option>
                  <% portions.forEach(function(portion) { %>
                  <option value="<%= portion._id %>">
                    <%= portion.portion %>
                  </option>
                  <% }); %>
                </select>
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  onclick="addPortion(document.getElementById('portionSelect-0'))"
                >
                  Adicionar
                </button>
              </div>
              <small class="text-danger portion-error" style="display: none">
                Pelo menos uma porção é obrigatória.
              </small>
            </div>
            <div class="mb-3">
              <label for="dishPhoto0" class="form-label">Foto do Prato:</label>
              <input
                type="file"
                accept="image/*"
                name="dishes[0][photo]"
                id="dishPhoto0"
                class="form-control"
                required
              />
            </div>
          </div>
        </div>

        <!-- Botão para adicionar mais formulários de prato -->
        <div class="mb-3">
          <button type="button" id="addDishBtn" class="btn btn-secondary">
            Adicionar Prato
          </button>
        </div>

        <!-- Botão para submeter o formulário do Menu -->
        <div class="mb-3">
          <button type="submit" class="btn btn-primary">Salvar Menu</button>
        </div>
      </form>
    </div>

    <%- include('../../../loading.ejs') %>

    <!-- Script para adição e remoção dinâmica dos formulários de prato -->
    <script>
      let dishIndex = 1; // O primeiro formulário já está indexado como 0

      document
        .getElementById("addDishBtn")
        .addEventListener("click", function () {
          if (dishIndex >= 10) {
            alert("O máximo de pratos é 10.");
            return;
          }
          const container = document.getElementById("dishesContainer");
          const newDish = document.createElement("div");
          newDish.classList.add("dish-form", "border", "p-3", "mb-3");
          newDish.setAttribute("data-index", dishIndex);
          // Para pratos adicionais, a categoria é de livre escrita (ou pode ser alterado conforme a lógica desejada)
          newDish.innerHTML = `
          <h5>Prato ${dishIndex + 1}</h5>
          <div class="mb-3">
            <label for="dishName${dishIndex}" class="form-label">Nome:</label>
            <input type="text" name="dishes[${dishIndex}][name]" id="dishName${dishIndex}" class="form-control" placeholder="Nome do prato" required maxlength="50" pattern="^[A-Za-zÀ-ÿ\s]+$">
          </div>
          <div class="mb-3">
            <label for="dishDescription${dishIndex}" class="form-label">Descrição:</label>
            <input type="text" name="dishes[${dishIndex}][description]" id="dishDescription${dishIndex}" class="form-control" placeholder="Descrição do prato" required maxlength="250">
          </div>
          <% if (categories && categories.length > 0) { %>
            <div class="mb-3">
              <label for="dishCategory${dishIndex}" class="form-label">Categoria:</label>
              <select name="dishes[${dishIndex}][category]" id="dishCategory${dishIndex}" class="form-select" required>
                <% categories.forEach(function(cat) { %>
                  <option value="<%= cat.category %>"><%= cat.category %></option>
                <% }); %>
              </select>
            </div>
          <% } else { %>
            <div class="mb-3">
              <label for="dishCategory${dishIndex}" class="form-label">Categoria:</label>
              <input type="text" name="dishes[${dishIndex}][category]" id="dishCategory${dishIndex}" class="form-control" required>
            </div>
          <% } %>
          <div class="mb-3">
            <label for="dishPrice${dishIndex}" class="form-label">Preço:</label>
            <input type="number" name="dishes[${dishIndex}][price]" id="dishPrice${dishIndex}" class="form-control" placeholder="Preço do prato" required min="0" step="0.01">
          </div>

          <div class="mb-3">
  <label class="form-label">Ingredientes:</label>
  <div id="ingredientsContainer-${dishIndex}">
    <div class="ingredient-item mb-2">
      <div class="input-group">
        <select class="form-select search-type" style="max-width: 150px;">
          <option value="name">Por Nome</option>
          <option value="barcode">Por Código</option>
        </select>
        <input
          type="text"
          name="dishes[${dishIndex}][ingredients][]"
          class="form-control ingredient-input"
          placeholder="Nome do ingrediente"
          required
        />
        <button type="button" class="btn btn-outline-danger remove-ingredient">×</button>
      </div>
    </div>
  </div>
  <button type="button" class="btn btn-sm btn-secondary add-ingredient">Adicionar Ingrediente</button>
  <small class="text-muted">Use vírgulas para múltiplos itens ou códigos de barras</small>
</div>

          <div class="mb-3">
            <label class="form-label">Porções:</label>
            <div id="portionsContainer-${dishIndex}" class="portions-container mb-3" data-index="${dishIndex}"></div>
            <div class="input-group">
              <select 
                id="portionSelect-${dishIndex}" 
                class="form-select portion-select"
                data-index="${dishIndex}"
                onchange="addPortion(this)"
              >
<option value="">Selecione uma porção...</option>
                  <% portions.forEach(function(portion) { %>
                  <option value="<%= portion._id %>">
                    <%= portion.portion %>
                  </option>
                  <% }); %>
                </select>
              <button 
                type="button" 
                class="btn btn-outline-secondary" 
                onclick="addPortion(document.getElementById('portionSelect-${dishIndex}'))"
              >
                Adicionar
              </button>
            </div>
            <small class="text-danger portion-error" style="display: none">
              Pelo menos uma porção é obrigatória
            </small>
          </div>
          <div class="mb-3">
            <label for="dishPhoto${dishIndex}" class="form-label">Foto do Prato:</label>
            <input type="file" accept="image/*" name="dishes[${dishIndex}][photo]" id="dishPhoto${dishIndex}" class="form-control" required>
          </div>
          <div class="mb-3">
            <button type="button" class="btn btn-danger removeDishBtn">Remover Prato</button>
          </div>
        `;
          container.appendChild(newDish);
          dishIndex++;
        });

      document
        .getElementById("dishesContainer")
        .addEventListener("click", function (e) {
          if (e.target && e.target.classList.contains("removeDishBtn")) {
            // Garante que haja pelo menos um prato (o primeiro não pode ser removido)
            if (document.querySelectorAll(".dish-form").length > 1) {
              e.target.closest(".dish-form").remove();
              reindexDishes();
            } else {
              alert("Você precisa ter pelo menos um prato no menu.");
            }
          }
        });

      function reindexDishes() {
        const dishForms = document.querySelectorAll(".dish-form");
        dishForms.forEach((form, index) => {
          form.setAttribute("data-index", index);
          const header = form.querySelector("h5");
          header.innerText = `Prato ${index + 1}`;

          const elements = form.querySelectorAll("input, select, label");
          elements.forEach((el) => {
            if (
              (el.tagName.toLowerCase() === "input" ||
                el.tagName.toLowerCase() === "select") &&
              el.hasAttribute("name")
            ) {
              let nome = el.getAttribute("name");
              nome = nome.replace(/dishes\[\d+\]/, `dishes[${index}]`);
              el.setAttribute("name", nome);
            }
            if (el.hasAttribute("id")) {
              let novoId = el.getAttribute("id").replace(/\d+$/, index);
              el.setAttribute("id", novoId);
            }
            if (
              el.tagName.toLowerCase() === "label" &&
              el.hasAttribute("for")
            ) {
              let novoFor = el.getAttribute("for").replace(/\d+$/, index);
              el.setAttribute("for", novoFor);
            }
          });
        });
        dishIndex = dishForms.length;
      }

      // Atualiza o required do input de preço conforme seleção de checkbox (caso necessário para outra lógica)
      document.addEventListener("DOMContentLoaded", function () {
        document.body.addEventListener("change", function (e) {
          if (e.target.classList.contains("portion-checkbox")) {
            const priceInput = e.target
              .closest(".form-check")
              .querySelector(".portion-price");
            priceInput.disabled = !e.target.checked;
            if (e.target.checked) {
              priceInput.required = true;
            } else {
              priceInput.required = false;
              priceInput.value = "";
            }
          }
        });
      });

      // Função para adicionar porção
      function addPortion(selectElement) {
        const index = selectElement.dataset.index;
        const container = document.getElementById(`portionsContainer-${index}`);
        const portionId = selectElement.value;
        if (!portionId) return;
        const portionName =
          selectElement.options[selectElement.selectedIndex].text;

        // Verifica se a porção já foi adicionada
        if (
          document.querySelector(
            `input[name^="dishes[${index}][portions]"][value="${portionId}"]`
          )
        ) {
          alert("Esta porção já foi adicionada");
          return;
        }

        // Adiciona a porção com o campo de preço obrigatório
        const div = document.createElement("div");
        div.className = "portion-item";
        div.innerHTML = `
          <div class="portion-content">
            <input type="hidden" name="dishes[${index}][portions][]" value="${portionId}">
            <span>${portionName}</span>
            <input type="number" class="form-control" name="dishes[${index}][portionPrices][]" placeholder="Preço" min="0" step="0.01" required>
          </div>
          <span class="remove-portion" onclick="removePortion(this)">✕</span>
        `;
        container.appendChild(div);

        // Ao invés de desabilitar a opção, oculta-a do dropdown para que não seja visível
        selectElement.options[selectElement.selectedIndex].style.display =
          "none";
        selectElement.value = "";
        validatePortions(index);
      }

      function removePortion(element) {
        const portionItem = element.closest(".portion-item");
        const container = portionItem.closest(".portions-container");
        const portionId = portionItem.querySelector(
          'input[type="hidden"]'
        ).value;
        const containerIndex = container.dataset.index;
        const selectElement = document.getElementById(
          `portionSelect-${containerIndex}`
        );

        // Restaura a opção removida para que volte a ser exibida
        Array.from(selectElement.options).forEach((option) => {
          if (option.value === portionId) {
            option.style.display = "";
          }
        });
        portionItem.remove();
        validatePortions(containerIndex);
      }

      // Validação para garantir que ao menos uma porção seja adicionada por prato
      function validatePortions(index) {
        const container = document.getElementById(`portionsContainer-${index}`);
        const error = container
          .closest(".mb-3")
          .querySelector(".portion-error");
        error.style.display =
          container.children.length === 0 ? "block" : "none";
      }

      // Gerenciamento de ingredientes
      document.querySelectorAll(".add-ingredient").forEach((button) => {
        button.addEventListener("click", function () {
          const container = this.previousElementSibling;
          const newItem = document.createElement("div");
          newItem.className = "ingredient-item mb-2";
          newItem.innerHTML = `
      <div class="input-group">
        <select class="form-select search-type" style="max-width: 150px;">
          <option value="name">Por Nome</option>
          <option value="barcode">Por Código</option>
        </select>
        <input
          type="text"
          name="${container.firstElementChild.querySelector("input").name}"
          class="form-control ingredient-input"
          placeholder="Nome do ingrediente"
          required
        />
        <button type="button" class="btn btn-outline-danger remove-ingredient">×</button>
      </div>
    `;
          container.appendChild(newItem);
        });
      });

      document.body.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-ingredient")) {
          const container = e.target.closest("#ingredientsContainer-0"); // Ajuste o índice conforme necessário
          if (container.children.length > 1) {
            e.target.closest(".ingredient-item").remove();
          }
        }
      });

      // Validação de código de barras
      document.querySelectorAll(".ingredient-input").forEach((input) => {
        input.addEventListener("blur", function () {
          if (this.closest(".search-type").value === "barcode") {
            if (!/^\d{8,13}$/.test(this.value)) {
              alert("Código de barras inválido! Deve conter 8-13 dígitos");
              this.focus();
            }
          }
        });
      });
    </script>
  </body>
</html>

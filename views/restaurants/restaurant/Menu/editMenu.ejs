<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/images/Plataform/LogoSite/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <title>Editar Menu</title>
    <style>
        .dish-card {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        .image-preview {
            max-width: 150px;
            height: auto;
            margin-bottom: 1rem;
        }
      /* Seus estilos aqui */
      .hero {
        background-size: cover;
        background-position: center;
        height: 60vh;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .hero-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
      }
      .hero-content {
        position: relative;
        z-index: 2;
        text-align: center;
        color: #fff;
        padding: 0 5vw;
      }
      .hero-content h1 {
        font-size: 4vw;
        margin-bottom: 2vh;
      }
      .hero-content p {
        font-size: 2vw;
        margin-bottom: 3vh;
      }
    </style>
</head>
<body>
    <%- include('../../../navBar.ejs') %>

    <% let backgroundImg = restaurant.perfil?.perfilPhoto ? 
        restaurant.perfil.perfilPhoto.replace(/\\/g, '/') : 
        "/images/Plataform/LogoSite/logo.png" %>

    <section class="hero mb-5" style="background-image: url('<%= backgroundImg %>');">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="text-white">Editar Menu</h1>
            <p class="lead text-white"><%= menu.name %></p>
        </div>
    </section>

    <div class="container">
        <form action="/restaurants/<%= restaurant.name %>/updateMenu/<%= menu._id %>" method="POST" enctype="multipart/form-data">
            <!-- Dados do Menu -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white ">
                    <h5 class="mb-0">Informações do Menu</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nome do Menu:</label>
                        <input type="text" name="name" class="form-control" value="<%= menu.name %>" required>
                    </div>

                    <% if (menu.photo) { %>
                        <div class="mb-3 text-center">
                            <img src="<%= menu.photo %>" class="image-preview">
                        </div>
                        
                    <% } %>
                    <div class="mb-3">
                        <label class="form-label">Alterar foto do Menu:</label>
                        <input type="file" 
                            name="menuPhoto" 
                            class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tipo do Menu:</label>
                        <select name="type" class="form-select" required>
                            <% categories.forEach(function(cat) { %>
                                <option value="<%= cat.category %>" <%= menu.type === cat.category ? 'selected' : '' %>>
                                    <%= cat.category %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Pratos Existentes -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Pratos Atuais</h5>
                </div>
                <div class="card-body">
                    <% menu.dishes.forEach((dish, index) => { %>
                        <div class="dish-card">
                            <input type="hidden" name="dishes[<%= index %>][_id]" value="<%= dish._id %>">
                            
                            <div class="mb-3">
                                <label class="form-label">Nome do Prato:</label>
                                <input type="text" 
                                    name="dishes[<%= index %>][name]" 
                                    class="form-control" 
                                    value="<%= dish.name %>" 
                                    required>
                            </div>

                            <% if (dish.photo) { %>
                                <div class="mb-3 text-center">
                                    <img src="<%= dish.photo %>" class="image-preview">
                                </div>
                                
                            <% } %>

                            <div class="mb-3">
                                <label class="form-label">Alterar Imagem:</label>
                                <input type="file" 
                                    name="dishes[<%= index %>][photo]" 
                                    class="form-control">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Descrição:</label>
                                <textarea name="dishes[<%= index %>][description]" 
                                    class="form-control" 
                                    rows="2" required><%= dish.description %></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Categoria:</label>
                                    <select name="dishes[<%= index %>][category]" class="form-select" required>
                                        <% categories.forEach(function(cat) { %>
                                            <option value="<%= cat.category %>" <%= dish.category === cat.category ? 'selected' : '' %>>
                                                <%= cat.category %>
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Preço:</label>
                                    <input type="number" 
                                        name="dishes[<%= index %>][price]" 
                                        class="form-control" 
                                        step="0.01" 
                                        value="<%= dish.price %>" 
                                        required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Porções:</label>
                                <div class="portion-container">
                                    <% portions.forEach(function(portion) { 
                                        const dishPortion = dish.portions.find(p => p.portion.toString() === portion._id.toString());
                                    %>
                                        <div class="form-check">
                                            <input class="form-check-input portion-checkbox" 
                                                type="checkbox" 
                                                name="dishes[<%= index %>][portions][]" 
                                                value="<%= portion._id %>"
                                                id="portion-<%= portion._id %>-<%= index %>"
                                                <%= dishPortion ? 'checked' : '' %>>
                                            
                                            <label class="form-check-label" for="portion-<%= portion._id %>-<%= index %>">
                                                <%= portion.portion %>
                                            </label>
                                            
                                            <input type="number" 
                                                class="form-control portion-price" 
                                                name="dishes[<%= index %>][portionPrices][]"
                                                value="<%= dishPortion ? dishPortion.price.toFixed(2) : '' %>"
                                                min="0" 
                                                step="0.01"
                                                <%= dishPortion ? '' : 'disabled' %>
                                                required>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" 
                                    type="checkbox" 
                                    name="deletedDishes" 
                                    value="<%= dish._id %>" 
                                    id="deleteDish<%= index %>">
                                <label class="form-check-label text-danger" for="deleteDish<%= index %>">
                                    Remover este prato
                                </label>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>

            <!-- Novos Pratos -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Adicionar Novos Pratos</h5>
                </div>
                <div class="card-body">
                    <div id="newDishesContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addNewDishField()">
                        Adicionar Prato
                    </button>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">Salvar Alterações</button>

                <button type="button" class="btn btn-danger btn-lg" onclick="confirmDelete()">Apagar Menu Completo</button>

                <a href="/restaurants/<%= restaurant.name %>/showMenu/<%= menu._id %>" 
                   class="btn btn-outline-secondary">
                    Cancelar
                </a>
            </div>
        </form>
    </div>

    <script>
        let newDishIndex = 0;
        
        function addNewDishField() {
            const container = document.getElementById('newDishesContainer');
            
            const dishDiv = document.createElement('div');
            dishDiv.className = 'dish-card mb-3';
            dishDiv.innerHTML = `
                <h6>Novo Prato ${newDishIndex + 1}</h6>
                <div class="mb-3">
                    <label class="form-label">Nome:</label>
                    <input type="text" 
                        name="newDishes[${newDishIndex}][name]" 
                        class="form-control" 
                        required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Imagem:</label>
                    <input type="file" 
                        name="newDishes[${newDishIndex}][photo]" 
                        class="form-control" 
                        required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Descrição:</label>
                    <textarea name="newDishes[${newDishIndex}][description]" 
                        class="form-control" 
                        rows="2" 
                        required></textarea>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Categoria:</label>
                        <select name="newDishes[${newDishIndex}][category]" class="form-select" required>
                            <% categories.forEach(function(cat) { %>
                                <option value="<%= cat.category %>"><%= cat.category %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço:</label>
                        <input type="number" 
                            name="newDishes[${newDishIndex}][price]" 
                            class="form-control" 
                            step="0.01" 
                            required>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">
                    Remover
                </button>
            `;
            
            container.appendChild(dishDiv);
            newDishIndex++;
        }

        function confirmDelete() {
            if (confirm('Tem certeza que deseja apagar este menu permanentemente?')) {
                fetch(`/restaurants/<%= restaurant.name %>/deleteMenu/<%= menu._id %>`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = `/restaurants/<%= restaurant.name %>`;
                    } else {
                        alert('Erro ao apagar o menu');
                    }
                });
            }
        }

            // Ativar/desativar preços conforme checkbox
    document.querySelectorAll('.portion-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const priceInput = this.closest('.form-check').querySelector('.portion-price');
            priceInput.disabled = !this.checked;
            priceInput.required = this.checked;
            if (!this.checked) priceInput.value = '';
        });
    });

    // Validação inicial para porções já marcadas
    document.querySelectorAll('.portion-checkbox:checked').forEach(checkbox => {
        checkbox.dispatchEvent(new Event('change'));
    });
    </script>

</body>
</html>
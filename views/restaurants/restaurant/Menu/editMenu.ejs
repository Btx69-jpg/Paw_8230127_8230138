<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="/images/Plataform/LogoSite/logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Editar Menu</title>
  
  <!-- CSS-->
  <link rel="stylesheet" href="/stylesheets/Restaurants/Restaurant/Pratos/portion.css">

  <style>
    .dish-card {
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      padding: 1rem;
      margin-bottom: 1rem;
      background-color: #f8f9fa;
    }
    .image-preview {
      max-width: 150px;
      height: auto;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <%- include('../navBarRest') %>

  <%- include('../../../hero', { title: 'Editar Menu', content: menu.name  }) %>

  <div class="container">
    <div class="container my-3">
      <a href="/restaurants/<%= restaurant.name %>" class="btn btn-primary">&lt;</a>
    </div>

    <form action="/restaurants/<%= restaurant.name %>/updateMenu/<%= menu._id %>" method="POST" enctype="multipart/form-data">
      <!-- Dados do Menu -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white ">
          <h5 class="mb-0">Informações do Menu</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Nome do Menu:</label>
            <input type="text" name="name" class="form-control" value="<%= menu.name %>" required>
          </div>

          <% if (menu.photo) { %>
            <div class="mb-3 text-center">
              <img src="<%= menu.photo %>" class="image-preview">
            </div>
          <% } %>
          <div class="mb-3">
            <label class="form-label">Alterar foto do Menu:</label>
            <input type="file" name="menuPhoto" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">Tipo do Menu:</label>
            <select name="type" class="form-select" required>
              <% categories.forEach(function(cat) { %>
                <option value="<%= cat.category %>" <%= menu.type === cat.category ? 'selected' : '' %>>
                  <%= cat.category %>
                </option>
              <% }); %>
            </select>
          </div>
        </div>
      </div>

      <!-- Pratos Existentes -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Pratos Atuais</h5>
        </div>
        <div class="card-body">
          <% menu.dishes.forEach((dish, index) => { %>
            <div class="dish-card">
              <input type="hidden" name="dishes[<%= index %>][_id]" value="<%= dish._id %>">
              <div class="mb-3">
                <label class="form-label">Nome do Prato:</label>
                <input type="text" name="dishes[<%= index %>][name]" class="form-control" value="<%= dish.name %>" required>
              </div>

              <% if (dish.photo) { %>
                <div class="mb-3 text-center">
                  <img src="<%= dish.photo %>" class="image-preview">
                </div>
              <% } %>

              <div class="mb-3">
                <label class="form-label">Alterar Imagem:</label>
                <input type="file" name="dishes[<%= index %>][photo]" class="form-control">
              </div>

              <div class="mb-3">
                <label class="form-label">Descrição:</label>
                <textarea name="dishes[<%= index %>][description]" class="form-control" rows="2" required><%= dish.description %></textarea>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Categoria:</label>
                  <select name="dishes[<%= index %>][category]" class="form-select" required>
                    <% categories.forEach(function(cat) { %>
                      <option value="<%= cat.category %>" <%= dish.category === cat.category ? 'selected' : '' %>>
                        <%= cat.category %>
                      </option>
                    <% }); %>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Preço:</label>
                  <input type="number" name="dishes[<%= index %>][price]" class="form-control" step="0.01" value="<%= dish.price %>" required>
                </div>
              </div>

              <!-- Seção de Porções (dinâmica) -->
              <div class="mb-3">
                <label class="form-label">Porções:</label>
                <div id="portionsContainer-<%= index %>" class="portions-container mb-3" data-index="<%= index %>">
                  <% 
                    // Obter os IDs das porções já selecionadas para este prato
                    let selectedPortions = dish.portions.map(dp => dp.portion.toString());
                    // Renderiza as porções já associadas
                    dish.portions.forEach(function(dishPortion) { 
                      const portionData = portions.find(p => p._id.toString() === dishPortion.portion.toString());
                  %>
                    <div class="portion-item">
                      <div class="portion-content">
                        <input type="hidden" name="dishes[<%= index %>][portions][]" value="<%= dishPortion.portion %>">
                        <span><%= portionData ? portionData.portion : 'Desconhecido' %></span>
                        <input type="number" class="form-control" name="dishes[<%= index %>][portionPrices][]" placeholder="Preço" min="0" step="0.01" value="<%= dishPortion.price.toFixed(2) %>" required>
                      </div>
                      <span class="remove-portion" onclick="removePortion(this)">✕</span>
                    </div>
                  <% }); %>
                </div>
                <div class="input-group">
                  <select id="portionSelect-<%= index %>" class="form-select portion-select" data-index="<%= index %>" onchange="addPortion(this)">
                    <option value="">Selecione uma porção...</option>
                    <% portions.forEach(function(portion) { 
                         // Exibe somente as porções não selecionadas anteriormente
                         if (!selectedPortions.includes(portion._id.toString())) { %>
                      <option value="<%= portion._id %>"><%= portion.portion %></option>
                    <% } }); %>
                  </select>
                  <button type="button" class="btn btn-outline-secondary" onclick="addPortion(document.getElementById('portionSelect-<%= index %>'))">
                    Adicionar
                  </button>
                </div>
                <small class="text-danger portion-error" style="display: none">
                  Pelo menos uma porção é obrigatória.
                </small>
              </div>

              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="deletedDishes" value="<%= dish._id %>" id="deleteDish<%= index %>">
                <label class="form-check-label text-danger" for="deleteDish<%= index %>">
                  Remover este prato
                </label>
              </div>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- Novos Pratos -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Adicionar Novos Pratos</h5>
        </div>
        <div class="card-body">
          <div id="newDishesContainer"></div>
          <button type="button" class="btn btn-secondary" onclick="addNewDishField()">
            Adicionar Prato
          </button>
        </div>
      </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary btn-lg">Salvar Alterações</button>
        <button type="button" class="btn btn-danger btn-lg" onclick="confirmDelete()">Apagar Menu Completo</button>
        <a href="/restaurants/<%= restaurant.name %>/showMenu/<%= menu._id %>" class="btn btn-outline-secondary">
          Cancelar
        </a>
      </div>
    </form>
  </div>

  <!-- Definindo variável global com dados das porções para uso na adição dinâmica -->
  <script>
    var portionsData = JSON.stringify(portions);
  </script>

  <script src="/javascripts/Restaurants/Restaurant/Menus/editMenus.js"></script>
</body>
</html>
